# Talkify 开发指南

## 目录

1. [项目概述](#1-项目概述)
2. [技术栈](#2-技术栈)
3. [项目架构](#3-项目架构)
4. [配置存储架构](#4-配置存储架构)
5. [代码规范](#5-代码规范)
6. [国际化](#6-国际化)
7. [资源文件](#7-资源文件)
8. [核心功能详解](#8-核心功能详解)
9. [引擎实现指南](#9-引擎实现指南)
10. [附录](#10-附录)

---

## 1. 项目概述

### 1.1 项目简介

Talkify 是一款由云端大模型驱动的 Android 语音合成(TTS)应用，通过接入云提供商的 AI TTS 在线服务实现高质量语音合成功能。

### 1.2 核心特性

- **多引擎支持**：支持接入多个云服务商的 TTS 服务，可在应用内切换
- **系统 TTS 集成**：作为系统 TTS 引擎，可被任意阅读软件调用
- **流式合成**：支持流式音频传输，降低延迟
- **Material 3 设计**：采用 Material 3 Expressive 设计语言
- **插件化架构**：基于接口的解耦设计，便于扩展新引擎

### 1.3 支持的引擎

| 引擎 ID | 名称 | 服务商 | 支持语言 | 声音数量 |
|---------|------|--------|----------|----------|
| `qwen3-tts` | 通义千问3 | 阿里云百炼 | 10种 | 48种 |
| `seed-tts-2.0` | 豆包语音合成2.0 | 火山引擎 | 2种 | 16种 |

---

## 2. 技术栈

### 2.1 核心技术

| 技术 | 版本 | 说明 |
|------|------|------|
| Kotlin | 2.3.0 | 编程语言 |
| Android Gradle Plugin | 8.13.2 | 构建工具 |
| minSdk | 30 (Android 11) | 最低支持版本 |
| targetSdk | 36 (Android 16) | 目标版本 |
| JVM Target | 17 | Java 虚拟机目标版本 |

### 2.2 UI 框架

| 库 | 版本 | 用途 |
|----|------|------|
| Jetpack Compose | BOM 2026.01.00 | UI 框架 |
| Material 3 | BOM 2026.01.00 | 设计系统 |
| Activity Compose | 1.12.2 | Compose Activity 支持 |
| Lifecycle Runtime | 2.10.0 | 生命周期管理 |

### 2.3 外部依赖

| 库 | 版本 | 用途 |
|----|------|------|
| DashScope SDK | 2.22.5 | 阿里云百炼通义千问3语音合成 |
| OkHttp | 4.12.0 | 火山引擎豆包语音合成2.0 HTTP API |

---

## 3. 项目架构

### 3.1 分层架构

项目采用清晰的分层架构，实现职责分离：

```
app/src/main/java/com/github/lonepheasantwarrior/talkify/
├── MainActivity.kt                    # 应用入口，网络检查与权限管理
├── TalkifyApplication.kt              # Application 类，全局初始化
├── TalkifyCheckDataActivity.kt        # 系统 TTS 数据检查 Activity
├── TalkifyDownloadVoiceData.kt        # 语音数据下载 Activity
├── TalkifySampleTextActivity.kt       # 系统采样文本 Activity
├── GlobalException.kt                 # 全局异常处理器
├── domain/                            # 领域层（业务逻辑核心）
│   ├── model/                         # 领域模型
│   │   ├── TtsEngine.kt               # TTS 引擎信息数据类
│   │   ├── BaseEngineConfig.kt        # 引擎配置抽象基类
│   │   ├── Qwen3TtsConfig.kt          # 通义千问3配置
│   │   ├── SeedTts2Config.kt          # 豆包语音合成2.0配置
│   │   ├── ConfigItem.kt              # 配置项数据类
│   │   ├── EngineIds.kt               # 引擎 ID 密封类
│   │   ├── TtsEngineRegistry.kt       # 引擎注册表
│   │   ├── UpdateInfo.kt              # 更新信息
│   │   └── UpdateCheckResult.kt       # 更新检查结果密封类
│   └── repository/                    # 仓储接口
│       ├── VoiceRepository.kt         # 声音仓储接口
│       ├── EngineConfigRepository.kt  # 引擎配置仓储接口
│       └── AppConfigRepository.kt     # 应用配置仓储接口
├── infrastructure/                    # 基础设施层
│   ├── engine/repo/                   # 引擎特定实现
│   │   ├── Qwen3TtsVoiceRepository.kt     # 通义千问3声音仓储
│   │   ├── Qwen3TtsConfigRepository.kt    # 通义千问3配置仓储
│   │   ├── SeedTts2VoiceRepository.kt     # 豆包声音仓储
│   │   └── SeedTts2ConfigRepository.kt    # 豆包配置仓储
│   └── app/                           # 应用级基础设施
│       ├── permission/                # 权限与网络
│       │   ├── PermissionChecker.kt           # 权限检查
│       │   ├── NetworkConnectivityChecker.kt  # 网络连通性检查
│       │   └── ConnectivityMonitor.kt         # 网络状态监控
│       ├── notification/              # 通知系统
│       │   ├── TalkifyNotificationHelper.kt   # 通知发送 Helper
│       │   ├── NotificationHelper.kt          # 底层通知工具
│       │   └── NotificationModels.kt          # 通知数据模型
│       ├── update/                    # 更新检查
│       │   └── UpdateChecker.kt               # GitHub Releases 检查
│       └── repo/                      # 应用配置实现
│           └── SharedPreferencesAppConfigRepository.kt
├── service/                           # 服务层
│   ├── TalkifyTtsService.kt           # 主 TTS 服务
│   ├── TalkifyTtsDemoService.kt       # 语音预览服务
│   ├── TtsErrorCode.kt                # 错误码定义
│   ├── TtsErrorHelper.kt              # 错误处理助手
│   ├── TtsLogger.kt                   # 日志工具
│   └── engine/                        # 引擎抽象层
│       ├── TtsEngineApi.kt            # 引擎 API 接口
│       ├── AbstractTtsEngine.kt       # 引擎抽象基类
│       ├── AudioConfig.kt             # 音频配置
│       ├── TtsEngineFactory.kt        # 引擎工厂
│       └── impl/                      # 引擎实现
│           ├── Qwen3TtsEngine.kt      # 通义千问3引擎
│           └── SeedTts2Engine.kt      # 豆包语音合成2.0引擎
├── ui/                                # 表现层
│   ├── components/                    # UI 组件
│   │   ├── EngineSelector.kt          # 引擎选择器
│   │   ├── VoicePreview.kt            # 语音预览控件
│   │   ├── ConfigEditor.kt            # 配置编辑器
│   │   ├── ConfigBottomSheet.kt       # 配置底部弹窗
│   │   ├── UpdateDialog.kt            # 更新对话框
│   │   ├── PermissionDialog.kt        # 权限请求对话框
│   │   ├── NotificationPermissionDialog.kt  # 通知权限弹窗
│   │   ├── NetworkBlockedDialog.kt    # 网络阻塞对话框
│   │   └── MarkdownText.kt            # Markdown 文本组件
│   ├── screens/                       # 屏幕
│   │   └── MainScreen.kt              # 主界面
│   └── theme/                         # 主题
│       ├── Color.kt                   # 颜色定义
│       ├── Theme.kt                   # 主题配置
│       └── Type.kt                    # 字体排版
└── util/                              # 工具类
    └── TalkifyAudioPlayer.kt          # 音频播放器
```

### 3.2 分层职责说明

#### 领域层 (domain/)

包含核心业务模型和接口定义，不依赖任何外部框架：

| 类/接口 | 说明 |
|---------|------|
| `TtsEngine` | TTS 引擎基本信息（id, name, provider） |
| `BaseEngineConfig` | 引擎配置抽象基类，定义通用属性 `voiceId` |
| `Qwen3TtsConfig` / `SeedTts2Config` | 具体引擎配置，继承基类并添加特有属性 |
| `TtsEngineRegistry` | 引擎注册表，管理可用引擎列表 |
| `VoiceRepository` | 声音列表获取接口 |
| `EngineConfigRepository` | 引擎配置存取接口 |
| `AppConfigRepository` | 应用全局配置接口 |

#### 基础设施层 (infrastructure/)

负责外部服务集成和数据持久化：

- **engine/repo/**: 引擎特定实现，如声音列表加载、配置存储
- **app/permission/**: 权限检查和网络状态监控
- **app/notification/**: 通知系统实现
- **app/update/**: 应用更新检查
- **app/repo/**: 应用全局配置实现

#### 服务层 (service/)

负责 TTS 引擎服务实现：

- **TalkifyTtsService**: 继承 `TextToSpeechService`，系统 TTS 服务实现
- **TalkifyTtsDemoService**: 语音预览服务，用于应用内播放测试
- **engine/**: 引擎抽象层和具体实现

#### 表现层 (ui/)

负责用户界面呈现：

- **components/**: 可复用的 UI 组件
- **screens/**: 完整屏幕界面
- **theme/**: 主题配置

---

## 4. 配置存储架构

### 4.1 设计原则

配置分为两类，确保职责清晰：

| 配置类型 | 接口 | 存储内容 | 存储文件 |
|---------|------|---------|---------|
| 全局配置 | `AppConfigRepository` | 当前选择的引擎、通知权限跳过状态 | `talkify_app_config.xml` |
| 引擎配置 | `EngineConfigRepository` | 引擎特定配置（API Key、voiceId） | `talkify_engine_configs.xml` |

### 4.2 配置层次设计

```kotlin
// 抽象基类：只定义所有引擎共有的属性
abstract class BaseEngineConfig(
    open val voiceId: String = ""
)

// 具体引擎配置：继承基类，添加引擎特有属性
data class Qwen3TtsConfig(
    override val voiceId: String = "",
    val apiKey: String = ""
) : BaseEngineConfig(voiceId)

data class SeedTts2Config(
    override val voiceId: String = "",
    val apiKey: String = ""
) : BaseEngineConfig(voiceId)
```

### 4.3 引擎选择持久化流程

```
应用启动
    ↓
AppConfigRepository.getSelectedEngineId()
    ↓
存在已保存ID → TtsEngineRegistry.getEngine() → 使用对应引擎
    ↓ 不存在
保存默认引擎ID → 使用默认引擎（通义千问3）
```

---

## 5. 代码规范

### 5.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 仓储实现 | `{引擎名}{类型}Repository` | `Qwen3TtsVoiceRepository` |
| 引擎 ID | 云服务官方产品标识符 | `qwen3-tts`, `seed-tts-2.0` |
| 引擎类 | `{引擎名}TtsEngine` | `Qwen3TtsEngine` |
| 配置类 | `{引擎名}TtsConfig` | `SeedTts2Config` |
| 常量 | 全大写下划线分隔 | `MAX_TEXT_LENGTH` |

### 5.2 KDoc 注释规范

公开 API 和关键组件必须添加 KDoc 注释：

```kotlin
/**
 * TTS 引擎 API 接口
 *
 * 定义语音合成引擎必须实现的核心方法
 * 采用接口设计，解耦引擎实现与调用方逻辑
 * 支持多引擎接入，每种引擎实现此接口即可
 */
interface TtsEngineApi

/**
 * 配置项数据类
 *
 * @param key 配置项唯一标识
 * @param label 显示标签
 * @param value 当前值
 * @param isPassword 是否为密码输入模式
 * @param isVoiceSelector 是否为语音选择模式
 */
data class ConfigItem(...)
```

### 5.3 Compose UI 规范

**状态管理**：
- 复杂状态使用 `remember { mutableStateOf(...) }`
- 派生状态使用 `derivedStateOf` 计算
- 避免不必要的重组，使用正确的依赖键

**ModalBottomSheet 使用**：
- 使用 `skipPartiallyExpanded = true` 避免部分展开状态
- 避免在 `LaunchedEffect` 中同时控制 show/hide

---

## 6. 国际化

### 6.1 字符串资源

所有 UI 文本定义在 `app/src/main/res/values/strings.xml`：

```xml
<!-- 通用 -->
<string name="settings">设置</string>
<string name="save">保存</string>
<string name="cancel">取消</string>

<!-- 主界面 -->
<string name="synthesis_engine">合成引擎</string>
<string name="provider_format">提供商: %1$s</string>

<!-- 语音预览 -->
<string name="voice_preview">语音预览</string>
<string name="input_text_label">输入要合成的文本</string>
```

### 6.2 使用规范

```kotlin
// 正确：先获取字符串
@Composable
fun ExampleComponent() {
    val title = stringResource(R.string.title)
    var text by remember { mutableStateOf(title) }
    // ...
}

// 错误：Composable 调用不在 Composable 上下文中
@Composable
fun ExampleComponent() {
    var text by remember { mutableStateOf(stringResource(R.string.title)) } // 编译错误！
}
```

---

## 7. 资源文件

### 7.1 资源文件列表

| 文件 | 用途 |
|------|------|
| `strings.xml` | UI 字符串资源 |
| `bailian-Qwen3-TTS-voices.xml` | 通义千问3声音配置（48种声音） |
| `volcengine-Seed-TTS-2-voices.xml` | 豆包语音合成2.0声音配置（16种声音） |
| `tts_engine.xml` | TTS 服务元数据声明 |

### 7.2 声音配置 XML 结构

```xml
<resources>
    <string-array name="bailian_qwen3_tts_voices">
        <item>aiweize</item>
        <item>aiyanan</item>
        <!-- 更多声音... -->
    </string-array>
    <string-array name="bailian_qwen3_tts_voice_names">
        <item>艾唯泽</item>
        <item>艾雅楠</item>
        <!-- 更多名称... -->
    </string-array>
</resources>
```

---

## 8. 核心功能详解

### 8.1 启动网络检查

应用启动时自动检查网络访问能力，确保 TTS 功能可用：

```
应用启动
    ↓
检查联网权限
    ↓ 无权限 → 弹窗提示，授权后跳转系统设置
    ↓ 有权限
检查网络可用性
    ↓ 无网络 → 弹窗提示
    ↓ 网络可用
TCP 连接测试（阿里云）
    ↓ 连接失败 → 弹窗提示（可能是 Android 16 "允许网络访问" 开关关闭）
    ↓ 连接成功 → 正常启动，检查更新
```

**核心组件**：
- `PermissionChecker`: 运行时权限检查
- `NetworkConnectivityChecker`: 网络连通性检查统一入口
- `ConnectivityMonitor`: 网络状态监控与 TCP 连接测试

### 8.2 通知权限请求

Android 13+ 需要 `POST_NOTIFICATIONS` 运行时权限：

```
应用启动
    ↓
检查是否已有通知权限 → 有 → 跳过
    ↓ 无
检查用户是否选择过"以后再说" → 是 → 跳过
    ↓ 否
显示 NotificationPermissionDialog
    ↓
用户选择"同意" → 向系统请求权限
用户选择"以后再说" → 持久化选择，下次不再弹窗
```

### 8.3 检查更新功能

应用启动时自动检查 GitHub Releases 是否有新版本：

```kotlin
// 使用 GitHub REST API
val apiUrl = "https://api.github.com/repos/LonePheasantWarrior/Talkify/releases/latest"

// UpdateCheckResult 密封类定义
sealed class UpdateCheckResult {
    data class UpdateAvailable(val updateInfo: UpdateInfo) : UpdateCheckResult()
    data object NoUpdateAvailable : UpdateCheckResult()
    data object NetworkTimeout : UpdateCheckResult()
    data class NetworkError(val message: String) : UpdateCheckResult()
    data class ServerError(val httpCode: Int) : UpdateCheckResult()
    data class ParseError(val message: String) : UpdateCheckResult()
}
```

**错误处理策略**：
- `NetworkTimeout`: 国内网络可能无法访问 GitHub，静默放弃
- `NetworkError`: 显示"网络连接失败，请检查网络设置"
- `ServerError`: 显示"GitHub 服务暂时不可用，请稍后再试"
- 404（无 Release）: 视为无更新，静默处理

### 8.4 错误处理体系

#### 8.4.1 错误码定义 (TtsErrorCode)

| 错误码 | 常量 | 含义 | 用户提示 |
|--------|------|------|----------|
| 1001 | `ERROR_NO_ENGINE` | 未找到可用引擎 | 未找到可用的 TTS 引擎 |
| 1002 | `ERROR_ENGINE_NOT_FOUND` | 引擎不存在 | 引擎不存在 |
| 1003 | `ERROR_ENGINE_NOT_CONFIGURED` | 引擎未配置 | 请先配置 API Key |
| 1004 | `ERROR_SYNTHESIS_FAILED` | 合成失败 | 语音合成失败 |
| 1005 | `ERROR_NETWORK_UNAVAILABLE` | 网络不可用 | 网络不可用，请检查网络连接 |
| 1006 | `ERROR_INVALID_REQUEST` | 无效请求 | 无效的合成请求 |
| 1007 | `ERROR_ENGINE_INIT_FAILED` | 引擎初始化失败 | 引擎初始化失败 |
| 1008 | `ERROR_CONFIG_NOT_FOUND` | 配置未找到 | 未找到引擎配置 |
| 1100 | `ERROR_GENERIC` | 通用错误 | 操作失败，请稍后重试 |
| 1101 | `ERROR_NETWORK_TIMEOUT` | 网络超时 | 网络连接超时，请检查网络设置 |
| 1102 | `ERROR_API_RATE_LIMITED` | API 频率限制 | 请求过于频繁，请稍后重试 |
| 1103 | `ERROR_API_SERVER_ERROR` | 服务端错误 | 服务暂时不可用，请稍后重试 |
| 1104 | `ERROR_API_AUTH_FAILED` | 认证失败 | 认证失败，请检查 API Key 配置 |
| 1105 | `ERROR_NOT_IMPLEMENTED` | 未实现 | 该引擎功能尚未实现 |
| 1099 | `ERROR_UNKNOWN` | 未知错误 | 发生未知错误 |

#### 8.4.2 全局异常处理

`TalkifyApplication` 初始化全局异常处理器：

```kotlin
class TalkifyApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        TalkifyAppHolder.setContext(this)
        TalkifyExceptionHandler.initialize()
    }
}
```

捕获未处理异常后显示崩溃对话框，提供"重启应用"选项。

#### 8.4.3 服务层错误处理

`TalkifyTtsService` 通过错误消息推断错误码：

```kotlin
private fun inferErrorCodeFromMessage(errorMessage: String): Int {
    return when {
        errorMessage.contains("API Key", ignoreCase = true) ||
        errorMessage.contains("认证", ignoreCase = true) -> 
            TtsErrorCode.ERROR_API_AUTH_FAILED
        errorMessage.contains("超时", ignoreCase = true) -> 
            TtsErrorCode.ERROR_NETWORK_TIMEOUT
        errorMessage.contains("频率", ignoreCase = true) ||
        errorMessage.contains("rate limit", ignoreCase = true) -> 
            TtsErrorCode.ERROR_API_RATE_LIMITED
        // ... 更多规则
    }
}
```

### 8.5 语音预览功能 (DemoService)

`TalkifyTtsDemoService` 是独立的 TTS 演示服务：

- 不依赖 Android TTS 系统框架
- 使用 `AudioTrack` 本地播放流式音频
- 支持播放、停止、释放操作
- 配置变更实时生效，无需重启应用

**使用流程**：
```
用户输入文本 → 选择音色 → 点击播放
    ↓
验证输入和配置
    ↓
demoService.speak(text, config, params)
    ↓
TtsEngineFactory 创建引擎
    ↓
引擎流式合成音频 → AudioTrack 实时播放
```

### 8.6 同步处理与资源管理

#### 8.6.1 同步处理机制

根据 Android 官方文档，`onSynthesizeText` 应阻塞直到合成完成。采用 `CountDownLatch` 实现：

```kotlin
private fun processRequestSynchronously(request: SynthesisRequest, callback: SynthesisCallback) {
    // 获取 WakeLock + WifiLock + 启动前台服务
    acquireWakeLock()
    acquireWifiLock()
    startForegroundService()
    
    try {
        // 初始化音频参数
        callback.start(sampleRate, audioFormat, channelCount)
        
        // 设置同步门闩
        synthesisLatch = CountDownLatch(1)
        
        // 执行合成
        engine.synthesize(text, params, config, listener)
        
        // 阻塞等待（120秒超时）
        synthesisLatch?.await(120, TimeUnit.SECONDS)
        
        // 完成或错误处理
        callback.done() / callback.error()
    } finally {
        // 统一清理资源
        releaseWifiLock()
        releaseWakeLock()
        stopForegroundService()
    }
}
```

#### 8.6.2 资源管理

| 资源 | 用途 | 配置 |
|------|------|------|
| WakeLock | 防止合成过程中设备休眠 | PARTIAL_WAKE_LOCK, 最长10分钟 |
| WifiLock | 确保 WiFi 高性能模式 | WIFI_MODE_FULL_LOW_LATENCY |
| 前台服务 | 提升服务优先级 | MEDIA_PLAYBACK 类型 |
| 信号量 | 限制并发处理数量为 1 | Semaphore(1) |

### 8.7 通知系统

#### 8.7.1 通知通道

| 通道 | ID | 重要性 | 用途 |
|------|-----|--------|------|
| TTS_PLAYBACK | `talkify_tts_playback` | IMPORTANCE_LOW | TTS 朗读状态通知 |
| SYSTEM_NOTIFICATION | `talkify_system` | IMPORTANCE_HIGH | 错误提示、系统消息 |

#### 8.7.2 通知使用场景

- **TTS_PLAYBACK**: 服务作为前台服务时显示"Talkify 正在朗读"
- **SYSTEM_NOTIFICATION**: 合成失败时显示 heads-up 悬浮通知

---

## 9. 引擎实现指南

### 9.1 引擎接口 (TtsEngineApi)

```kotlin
interface TtsEngineApi {
    fun getEngineId(): String
    fun getEngineName(): String
    fun isConfigured(config: BaseEngineConfig?): Boolean
    fun synthesize(text: String, params: SynthesisParams, 
                   config: BaseEngineConfig, listener: TtsSynthesisListener)
    fun stop()
    fun release()
    fun getAudioConfig(): AudioConfig
    fun getSupportedLanguages(): Set<String>
    fun getDefaultLanguages(): Array<String>
    fun getSupportedVoices(): List<Voice>
    fun getDefaultVoiceId(lang: String?, country: String?, 
                          variant: String?, currentVoiceId: String?): String
    fun isVoiceIdCorrect(voiceId: String?): Boolean
    fun createDefaultConfig(): BaseEngineConfig
    fun getConfigLabel(configKey: String, context: Context): String?
}
```

### 9.2 合成监听器 (TtsSynthesisListener)

```kotlin
interface TtsSynthesisListener {
    fun onSynthesisStarted()
    fun onAudioAvailable(audioData: ByteArray, sampleRate: Int, 
                         audioFormat: Int, channelCount: Int)
    fun onSynthesisCompleted()
    fun onError(error: String)
}
```

### 9.3 引擎抽象基类 (AbstractTtsEngine)

提供共性功能的默认实现：

```kotlin
abstract class AbstractTtsEngine : TtsEngineApi {
    @Volatile
    protected var isReleased = false
    
    protected fun checkNotReleased() {
        if (isReleased) throw IllegalStateException("Engine has been released")
    }
    
    // 日志工具方法
    protected fun logDebug(message: String) = TtsLogger.d(tag) { message }
    protected fun logInfo(message: String) = TtsLogger.i(tag) { message }
    protected fun logError(message: String, throwable: Throwable? = null) = 
        TtsLogger.e(tag, throwable) { message }
    
    override fun release() {
        isReleased = true
    }
}
```

### 9.4 音频配置 (AudioConfig)

```kotlin
data class AudioConfig(
    val sampleRate: Int,      // 采样率（如 24000）
    val audioFormat: Int,     // 音频格式（如 AudioFormat.ENCODING_PCM_16BIT）
    val channelCount: Int     // 声道数（1=单声道，2=立体声）
) {
    companion object {
        val QWEN3_TTS = AudioConfig(24000, AudioFormat.ENCODING_PCM_16BIT, 1)
        val SEED_TTS2 = AudioConfig(24000, AudioFormat.ENCODING_PCM_16BIT, 1)
    }
}
```

### 9.5 添加新引擎步骤

1. **创建配置类**（domain/model/）
   ```kotlin
   data class NewTtsConfig(
       override val voiceId: String = "",
       val apiKey: String = ""
   ) : BaseEngineConfig(voiceId)
   ```

2. **实现引擎类**（service/engine/impl/）
   ```kotlin
   class NewTtsEngine : AbstractTtsEngine() {
       companion object {
           const val ENGINE_ID = "new-tts"
           const val ENGINE_NAME = "新引擎名称"
           val SUPPORTED_LANGUAGES = arrayOf("zho", "eng")
       }
       
       override fun getEngineId() = ENGINE_ID
       override fun getEngineName() = ENGINE_NAME
       override fun getSupportedLanguages() = SUPPORTED_LANGUAGES.toSet()
       override fun createDefaultConfig() = NewTtsConfig()
       
       override fun synthesize(...) {
           // 实现合成逻辑
       }
   }
   ```

3. **创建仓储实现**（infrastructure/engine/repo/）
   - `NewTtsVoiceRepository`: 从资源文件加载声音列表
   - `NewTtsConfigRepository`: SharedPreferences 配置存储

4. **注册引擎**（在 `TtsEngineFactory.initializeEngines()`）
   ```kotlin
   private fun initializeEngines(): Map<String, () -> TtsEngineApi> {
       return mapOf(
           Qwen3TtsEngine.ENGINE_ID to { Qwen3TtsEngine() },
           SeedTts2Engine.ENGINE_ID to { SeedTts2Engine() },
           NewTtsEngine.ENGINE_ID to { NewTtsEngine() }  // 新增
       )
   }
   ```

5. **添加引擎注册表**（domain/model/TtsEngineRegistry.kt）
   ```kotlin
   val availableEngines: List<TtsEngine> = listOf(
       TtsEngine(Qwen3TtsEngine.ENGINE_ID, "...", "..."),
       TtsEngine(SeedTts2Engine.ENGINE_ID, "...", "..."),
       TtsEngine(NewTtsEngine.ENGINE_ID, "...", "...")  // 新增
   )
   ```

6. **添加资源文件**（res/values/）
   - 创建 `new-tts-voices.xml` 定义声音列表

7. **更新配置弹窗**（ui/components/ConfigBottomSheet.kt）
   - 在 `buildConfigItems()` 和 `buildConfigFromItems()` 中添加新引擎分支

8. **更新 TTS 服务**（service/TalkifyTtsService.kt）
   - 在 `getEngineConfigRepository()` 中添加新引擎配置仓储映射

### 9.6 引擎实现对比

| 特性 | 通义千问3 | 豆包语音合成2.0 |
|------|-----------|-----------------|
| 提供商 | 阿里云 | 火山引擎 |
| SDK | DashScope SDK | OkHttp (HTTP API) |
| API 端点 | SDK 内部管理 | `openspeech.bytedance.com` |
| 认证方式 | API Key | API Key |
| 支持语言 | 10种 | 2种 |
| 声音数量 | 48种 | 16种 |
| 流式协议 | SDK 内部实现 | HTTP 流式响应 |
| 连接复用 | SDK 管理 | ConnectionPool |
| 文本分块 | 支持（550字符） | 支持（500字符） |
| 语速参数 | SDK 内部处理 | [-50, 100] 范围转换 |
| 音量参数 | SDK 内部处理 | [-50, 100] 范围转换 |

---

## 10. 附录

### 10.1 依赖配置参考

**gradle/libs.versions.toml**:
```toml
[versions]
agp = "8.13.2"
kotlin = "2.3.0"
composeBom = "2026.01.00"
dashscope = "2.22.5"
okhttp = "4.12.0"

[libraries]
dashscope-sdk = { group = "com.alibaba", name = "dashscope-sdk-java", version.ref = "dashscope" }
okhttp = { group = "com.squareup.okhttp3", name = "okhttp", version.ref = "okhttp" }
```

**app/build.gradle.kts**:
```kotlin
dependencies {
    // 阿里云百炼 DashScope SDK
    implementation(libs.dashscope.sdk)
    
    // OkHttp 用于火山引擎 HTTP API
    implementation(libs.okhttp)
    
    // Compose BOM 自动管理 Compose 版本
    implementation(platform(libs.androidx.compose.bom))
    implementation(libs.androidx.compose.material3)
}
```

### 10.2 构建命令

```bash
# Debug 构建
./gradlew assembleDebug

# Release 构建
./gradlew assembleRelease

# 代码检查
./gradlew lint

# 清理
./gradlew clean
```

### 10.3 版本历史

| 版本 | 日期 | 主要更新 |
|------|------|----------|
| 1.0.9 | 2026-01 | 豆包语音合成2.0支持、网络检查优化 |
| 1.0.0 | 2025-12 | 初始版本，通义千问3引擎 |

### 10.4 参考链接

- [Android TTS 文档](https://developer.android.com/reference/android/speech/tts/TextToSpeech)
- [阿里云百炼通义千问3](https://bailian.console.aliyun.com/)
- [火山引擎豆包语音合成](https://www.volcengine.com/docs/6561/1598757)
- [Jetpack Compose 文档](https://developer.android.com/jetpack/compose)
- [Material 3 设计规范](https://m3.material.io/)

---

*文档版本: 2026.01*
*最后更新: 与代码版本 1.0.9 同步*
